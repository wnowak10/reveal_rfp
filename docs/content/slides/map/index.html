<!-- used resources: -->
<!-- 

 -->
<!-- http://www.d3noob.org/2013/01/adding-title-to-your-d3js-graph.html
hover: http://bl.ocks.org/mattparrilla/5724610
basic chloropleth https://bl.ocks.org/mbostock/4060606
youtube map https://www.youtube.com/watch?v=G-VggTK-Wlg
click zoom http://bl.ocks.org/phil-pedruco/7557092 -->
<!-- scroll zoom https://bl.ocks.org/iamkevinv/0a24e9126cd2fa6b283c6f2d774b69a2 -->
<!-- scale https://bl.ocks.org/andrew-reid/496078bd5e37fd22a9b43fd6be84b36b -->
<!-- https://bl.ocks.org/d3noob/bdf28027e0ce70bd132edc64f1dd7ea4 bar chart v4! -->
<!-- 

 -->

<!DOCTYPE html>
<meta charset="utf-8">
<head>
<link rel="stylesheet" type="text/css" href="map.css">
<style type="text/css">
  
  #dd {
  position: absolute;
  top: 275px;
  left: 900px;
  background: #f08080;
  padding-right: 26px;
  border-radius: 3px;
  border: none;
  color: white;
  margin: 0;
  padding: 0 12px;
  width: auto;
  cursor: pointer;
  height: 30px;
}

.limit {
    position: absolute;
    top: 50%;
    left: 50%;
}

#maphover.tooltip { 
    /* Position the tooltip */
    position: absolute;
    text-align: center;     
    width: 80px;    
    height: auto;         
    padding: 2px;       
    font: 12px sans-serif;    
    background: lightblue; 
    border: 0px;    
    border-radius: 8px;     
    pointer-events: none;  
    font-family: "Source Sans Pro", Helvetica, sans-serif;
  font-weight: 600;
  line-height: 1.2;
  letter-spacing: normal;
}


#vis{
  float: left;
  position: absolute;
  top: 350px;
  left: 750px;
}

/*#overlay {
    position: absolute;
    top: 0;
    left: 0;
    height: 100%;
    width: 100%;
    background-color: rgba(0,0,0,0.5);
    z-index: 10;
}
*/
</style>
</head>


<script src="https://d3js.org/d3.v4.min.js"></script> 
<script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script> 
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script> 
<script src="https://d3js.org/topojson.v2.min.js"></script>
<script src="https://d3js.org/d3-axis.v1.min.js"></script>
<script src="https://d3js.org/d3-drag.v1.min.js"></script>
<script src="https://cdn.rawgit.com/vast-engineering/jquery-popup-overlay/1.7.13/jquery.popupoverlay.js"></script>


<body onclick="off()" onresize="off()">
 <!-- Turn off the overlay on click -->
  <div id="title"></div>

  <div id="selectors">
      <div id ="vis"></div>
      <div id="play-button"> </div>
      <div id="dropdown"> </div>
  </div>

  <div id="charts"> </div>


   <div class="modal" id="overlay"> 
    Hover over map for county identification. Zoom for a closer look!
    (Click to remove this dialogue box.)
    </div>

</body>


<script>

//////////////////////////////////////////
//////////////////////////////////////////
// Javascript page dynamics.
//////////////////////////////////////////
//////////////////////////////////////////
// var turnedoff = false;
function off() {
    document.getElementById("overlay").style.display = "none";
}

 // $(document).ready(function() {

 //      // Initialize the plugin
 //      $('#fade').popup();

 //    });

//////////////////////////////////////////
//////////////////////////////////////////
// Set the dimensions of the canvas/graph.
//////////////////////////////////////////
//////////////////////////////////////////

var margin = {top: 40, right: 20, bottom: 30, left: 50};
var titlewidth = 1100;
var titleheight = 60;
var textWidth = titlewidth / 2


//////////////////////////////////////////
//////////////////////////////////////////
// Set globals
//////////////////////////////////////////
//////////////////////////////////////////
var current_county_id; 


//////////////////////////////////////////
//////////////////////////////////////////
// Set the title.
//////////////////////////////////////////
//////////////////////////////////////////
var titlesvg = d3.select("#title")
    .append("svg")
    .attr("width", titlewidth)
    .attr("height", titleheight); 


titlesvg.append("svg").append("text")
        .attr("x", textWidth) // Center            
        .attr("y", margin.top*.7) 
        .attr("text-anchor", "middle")  
        .style("font-size", "36px") 
        .attr("class", "title")  
        .text("POVERTY IN AMERICA")


//////////////////////////////////////////
//////////////////////////////////////////
// Build slider
//////////////////////////////////////////
//////////////////////////////////////////

var startDate = 2010; //new Date("2010"),
var endDate = 2016.5; //new Date("2017");

var slidermargin = {top:0, right:50, bottom:0, left:50},
    sliderwidth = 360 - slidermargin.left - slidermargin.right,
    sliderheight = 100 - slidermargin.top - slidermargin.bottom;

var svg = d3.select("#vis")
    .append("svg")
    .attr("width", sliderwidth + slidermargin.left + slidermargin.right)
    .attr("height", sliderheight + slidermargin.top + slidermargin.bottom);  

var moving = false;
var currentValue = 0;
var targetValue = sliderwidth;

var playButton = d3.select("#play-button").append("button").attr("id", "pb").text("Play");
    
var x = d3.scaleLinear() //scaleTime()
    .domain([startDate, endDate])
    .range([0, targetValue])
    .clamp(true);

var slider = svg.append("g")
    .attr("class", "slider")
    .attr("transform", "translate(" + margin.left + ","+sliderheight/2+")");

slider.append("line")
    .attr("class", "track")
    .attr("x1", x.range()[0])
    .attr("x2", x.range()[1])
  .select(function() { return this.parentNode.appendChild(this.cloneNode(true)); })
    .attr("class", "track-inset")
  .select(function() { return this.parentNode.appendChild(this.cloneNode(true)); })
    .attr("class", "track-overlay")
    .call(d3.drag()
        .on("start.interrupt", function() { slider.interrupt(); })
        .on("start drag", function() {
          currentValue = d3.event.x;
          update(x.invert(currentValue)); 
        })
    );

slider.insert("g", ".track-overlay")
    .attr("class", "ticks")
    .attr("transform", "translate(0," + 18 + ")")
  .selectAll("text")
    .data(x.ticks(6))
    .enter()
    .append("text")
    .attr("x", x)
    .attr("y", 10)
    .attr("text-anchor", "middle")
    .text(function(d) { return (d); }); // Label

var handle = slider.insert("circle", ".track-overlay")
    .attr("class", "handle")
    .attr("r", 9);

var label = slider.append("text")  
    .attr("class", "label")
    .attr("text-anchor", "middle")
    .text("2010")
    .attr("transform", "translate(0,-25)")

playButton
    .on("click", function() {
        var button = d3.select(this);
        if (button.text() == "Pause") {
            moving = false;
            clearInterval(timer);
            button.text("Play");
        } 
        else {
            moving = true;
            timer = setInterval(step, 100);
            button.text("Pause");
            }
    });

//////////////////////////////////////////
//////////////////////////////////////////
// Build dropdown
//////////////////////////////////////////
//////////////////////////////////////////

var dropdown_options = [ 
// { value: "all",
  // text: "All races" },
{ value: "black",
  text: "Black Households" },
{ value: "white",
  text: "White Households" }]


var initial_value = "black";
var ddbutton = d3.select("#dropdown").append("select");


ddbutton
    .attr("id", "dd")
          .selectAll("option")
          .data(dropdown_options)
          .enter()
          .append("option")
          .attr("value", function(option) { 
            selectedValue = option.value;
            return selectedValue; 
          })
          .text(function(option) { return option.text; });

ddbutton.on("change", change)
var v;
function change() {
    v=  this.options[this.selectedIndex].value;
    dict_to_use = dict_of_dicts[v]     
    poverty_dict = dict_to_use[initialYear]
    console.log('race change', v)
    drawMapOutline(usa, poverty_dict, initialYear, v);
    chartonClick(current_county_id, numclicks, initialYear, v);
};


//////////////////////////////////////////
//////////////////////////////////////////
// Update plots
//////////////////////////////////////////
//////////////////////////////////////////

var dataset;

var plot = svg.append("g")
    .attr("class", "plot")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

function prepare(d) {
  d.id = d.id;
  d.year = d.year; // Keep as string
  return d;
}
  
function step() {
  update(x.invert(currentValue));
  currentValue = currentValue + (targetValue/60);
  if (currentValue > targetValue) {
    moving = false;
    currentValue = 0;
    clearInterval(timer);
    playButton.text("Play");
  }
}


var initialYear = 2010;
var race = initial_value;
function update(h) {

    handle.attr("cx", x(h));
    label
      .attr("x", x(h))
      .text(Math.floor(h));

    if ( (Math.floor(h+.2) > initialYear) | (Math.floor(h+.2) < initialYear) ){

      initialYear = Math.round(h,0);
      if (v == undefined){
        race = initial_value;
        dict_to_use = dict_of_dicts[race]
      }
      else {
        race = v;
         dict_to_use = dict_of_dicts[race]
      }

      poverty_dict = dict_to_use[initialYear]

      drawMapOutline(usa, poverty_dict, initialYear, race);

    };
  
};

//////////////////////////////////////////
//////////////////////////////////////////
// Set the dimensions of the canvas/graph.
// Begin to make the map.

//////////////////////////////////////////
//////////////////////////////////////////
var margin = {top: 40, right: 20, bottom: 30, left: 50};
var width = 700;
var height = 350;


var chart1 = d3.select("#charts").append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom);

var g = chart1.append("g");
var color = d3.scaleLinear().domain([0, .5]).range(['#ffeaea', '#660404']);

//////////////////////////////////////////
//////////////////////////////////////////
// Zoom functionality.
//////////////////////////////////////////
//////////////////////////////////////////
function zoomed() {
  g.style("stroke-width", 1.5 / d3.event.transform.k + "px");
  g.attr("transform", d3.event.transform);
};

var zoom = d3.zoom()
    .scaleExtent([1, 8])
    .on("zoom", zoomed);
chart1
    .call(zoom);

//////////////////////////////////////////
// Scale map down
//////////////////////////////////////////
function scale (scaleFactor,width,height) {
  return d3.geoTransform({
    point: function(x, y) {
      this.stream.point( (x - width/2) * scaleFactor+300 +100, (y - height/2) * scaleFactor- 70);
                          }
  });
}
var mapScale = .7
var path = d3.geoPath()
  .projection(scale(mapScale,width,height))

//////////////////////////////////////////
// Interactive map function.
//////////////////////////////////////////
// var numclicks = -1;
// function incrementValue(){
//   numclicks+=1;
//   if (numclicks > 4){
//     numclicks = (numclicks%5);
//   }
//  }
 
function drawMapOutline(us, poverty_dict, initialYear, race) {

  g.append("g")
      .attr("class", "counties")
      .selectAll("path")
      .data(topojson.feature(us, us.objects.counties).features)
      .enter()
      .append("path")
      .attr("fill", function(d) { return color(poverty_dict.get(d.id)); })

      .on("click", function(d){
          
          // if (numclicks < 0){

              // $('#fade').popup({
              //   transition: 'all 0.3s',
              //   scrolllock: true // optional
              // });
              

             // Click and scroll to bar chart.  
              // $('html,body').animate({
              // scrollTop: $("#chart2").offset().top},
              // 'slow');
          // }
          // incrementValue();
          current_county_id = get_current_county_id(d)
          numclicks = 0
          chartonClick(current_county_id, numclicks, initialYear, race);
      })

      .attr("transform", "translate("+-2*margin.left+","+5*margin.top+")")
      .attr("d", path)
      .on("mouseover", function(d, i, c) { 
          d3.select(this)
          .style("fill", "darkblue");

          d3.select(this)
            div.transition()    
                .duration(200)    
                .attr("id", "maphover")
                .style("opacity", .9);

            div.html("Poverty rate: " + Math.round(poverty_dict.get(d.id)*100) + "% in " + county.get(d.id) + ", " + state.get(d.id)) 
                .attr("id", "maphover")
                .style("left", (d3.event.pageX + 28) + "px")   
                .style("top", (d3.event.pageY) + "px");  
            })
      .on("mouseout", function(d) {
                    d3.select("#tooltip").remove();

                    d3.select(this)
                    .transition()
                    .duration(600)
                    .style("fill", function(d) { return color(poverty_dict.get(d.id)); })
                });;
      

  g.append("path")
      .datum(topojson.mesh(us, us.objects.states, function(a, b) { return a !== b; }))
      .attr("class", "states")
      .attr("transform", "translate("+-2*margin.left+","+5*margin.top+")")
      .attr("d", path);

  chart1.append("path")
      .datum(topojson.mesh(us, us.objects.counties, function(a, b) { return a !== b; }))
      .attr("class", "counties")
      .attr("transform", "translate("+-2*margin.left+","+5*margin.top+")")
      .attr("d", path);
}; // Close ready() function


var county = d3.map();
var state = d3.map();

var poverty2010 = d3.map();
var poverty2011 = d3.map();
var poverty2012 = d3.map();
var poverty2013 = d3.map();
var poverty2014 = d3.map();
var poverty2015 = d3.map();
var poverty2016 = d3.map();

var usa;
d3.queue()
    // .defer(d3.json, "https://d3js.org/us-10m.v1.json") // USA County Map
    .defer(d3.json, "usa.json", function(us){
      usa = us;
    })
    .defer(d3.csv, "mapData/black/black2010map.csv", function(d) { 
      poverty2010.set(d.id, +d.percent_poor);
      county.set(d.id, d.County); 
      state.set(d.id, d.State); 
    })
    .defer(d3.csv, "mapData/black/black2011map.csv", function(d) { poverty2011.set(d.id, +d.percent_poor); })
    .defer(d3.csv, "mapData/black/black2012map.csv", function(d) { poverty2012.set(d.id, +d.percent_poor); })
    .defer(d3.csv, "mapData/black/black2013map.csv", function(d) { poverty2013.set(d.id, +d.percent_poor); })
    .defer(d3.csv, "mapData/black/black2014map.csv", function(d) { poverty2014.set(d.id, +d.percent_poor); })
    .defer(d3.csv, "mapData/black/black2015map.csv", function(d) { poverty2015.set(d.id, +d.percent_poor); })
    .defer(d3.csv, "mapData/black/black2016map.csv", function(d) { poverty2016.set(d.id, +d.percent_poor); })

    .await(done);


blackmaps = {
  2010: poverty2010,
  2011: poverty2011,
  2012: poverty2012,
  2013: poverty2013,
  2014: poverty2014,
  2015: poverty2015,
  2016: poverty2016
};

var white2010 = d3.map();
var white2011 = d3.map();
var white2012 = d3.map();
var white2013 = d3.map();
var white2014 = d3.map();
var white2015 = d3.map();
var white2016 = d3.map();


d3.queue()
    .defer(d3.csv, "mapData/white/white2010map.csv", function(d) { white2010.set(d.id, +d.percent_poor); })
    .defer(d3.csv, "mapData/white/white2011map.csv", function(d) { white2011.set(d.id, +d.percent_poor); })
    .defer(d3.csv, "mapData/white/white2012map.csv", function(d) { white2012.set(d.id, +d.percent_poor); })
    .defer(d3.csv, "mapData/white/white2013map.csv", function(d) { white2013.set(d.id, +d.percent_poor); })
    .defer(d3.csv, "mapData/white/white2014map.csv", function(d) { white2014.set(d.id, +d.percent_poor); })
    .defer(d3.csv, "mapData/white/white2015map.csv", function(d) { white2015.set(d.id, +d.percent_poor); })
    .defer(d3.csv, "mapData/white/white2016map.csv", function(d) { white2016.set(d.id, +d.percent_poor); })
    .await(done);

function done(d){
  // console.log("Read");
}



whitemaps = {
  2010: white2010,
  2011: white2011,
  2012: white2012,
  2013: white2013,
  2014: white2014,
  2015: white2015,
  2016: white2016
};



// allmaps = {
//   2010: all2010,
//   2011: all2011,
//   2012: all2012,
//   2013: all2013,
//   2014: all2014,
//   2015: all2015,
//   2016: all2016
// };

dict_of_dicts = {
  "white" : whitemaps,
  "black" : blackmaps
  // "all" : allmaps
}

d3.json("usa.json", function(d){
  drawMapOutline(d, blackmaps[2010], 2010, race);
} );



var poverty = d3.map();
var state = d3.map();
var county = d3.map();





/////////////////////////////////////////////
/////////////////////////////////////////////
/////////////////////////////////////////////
// Prepare for second chart.
/////////////////////////////////////////////
/////////////////////////////////////////////
/////////////////////////////////////////////
 var chart2 = d3.select("#charts").append("svg") // append to svg will put side by side if there is enough room.
    .attr("width", width) 
    .attr("height", height)
    .attr('id', "chart2")
  	.append("g")
  	.attr("transform","translate(40,"+(height/2)+")"); // Move chart to center of SVG

var distribution_breakdowns = [
                                "Estimate; Total: - Less than $10,000" // 0
                                ,"Estimate; Total: - $10,000 to $14,999"
                                ,"Estimate; Total: - $15,000 to $19,999"

                                ,"Estimate; Total: - $20,000 to $24,999" // 4
                                ,"Estimate; Total: - $25,000 to $29,999"
                                ,"Estimate; Total: - $30,000 to $34,999"

                                ,"Estimate; Total: - $35,000 to $39,999" // 7
                                ,"Estimate; Total: - $40,000 to $44,999"
                                ,"Estimate; Total: - $45,000 to $49,999"

                                ,"Estimate; Total: - $50,000 to $59,999" //10
                                ,"Estimate; Total: - $60,000 to $74,999"

                                ,"Estimate; Total: - $75,000 to $99,999" //12

                                ,"Estimate; Total: - $100,000 to $124,999" //13
                                ,"Estimate; Total: - $125,000 to $149,999"
                                ,"Estimate; Total: - $150,000 to $199,999"
                                ,"Estimate; Total: - $200,000 or more"
                              ]

/////////////////////////////////////////////
// Helper functions for onclick update.
/////////////////////////////////////////////
function filterbyCounty(x, currentCounty, currentState){
  return x.filter(function(d) { return d.County === currentCounty & d.State === currentState; });
};

function getDistribution(data){
  var proportions = []
  var countyPopulation = data[0]["Estimate; Total:"]
  // Populate the income distribution list `proportions`
  for(var i=0; i<distribution_breakdowns.length; i++){
    proportions.push( data[0][distribution_breakdowns[i]]  / countyPopulation);
  }
  return proportions
};

function low_Middle_High_class(proportions){
  newData = []
  below20 = 0
  for(var i=0; i<4;i++){
    below20 += proportions[i]
  }
  newData.push(below20)

  twenty_to_thirtyfive = 0
  for(var i=4; i<7;i++){
    twenty_to_thirtyfive += proportions[i]
  }
  newData.push(twenty_to_thirtyfive)

  thirtyfive_to_fifty = 0
  for(var i=7; i<10;i++){
    thirtyfive_to_fifty += proportions[i]
  }
  newData.push(thirtyfive_to_fifty)

  fifty_to_seventyfive = 0
  for(var i=10; i<12;i++){
    fifty_to_seventyfive += proportions[i]
  }
  newData.push(fifty_to_seventyfive)

  seventyfive_to_hundred = 0
  for(var i=12; i<13;i++){
    seventyfive_to_hundred += proportions[i]
  }
  newData.push(seventyfive_to_hundred)
  
  over_hundred = 0
  for(var i=13; i<16;i++){
    over_hundred += proportions[i]
  }
  newData.push(over_hundred)

  return newData;

};
var barSpacing = 100;
var barWidth = 50;
function bar_location(d,i, numclicks){
  bar_loc =  (i*barSpacing)+barWidth*(numclicks);
  // bar_loc = barWidth+ (i*barSpacing)+barWidth*(numclicks);
  return bar_loc;
};

function spread(i){
  // Spread a sequence (say, of x values), out.
  return i*barSpacing+barWidth;
};

classes = ["<$20K", "$20-35K", "$35-50K", "$50-$75K", "$75-100K", ">$100K"]
function get_CLASS_bar_x_positions(){
  var barXvalues = [];
  for(var i=0; i<classes.length; i++){
    barXvalues.push(spread(i));
  }
  return barXvalues;
};

var y_axisLength = (height / 2);
function getYscale(proportions){
  var maxValue = d3.max(proportions, function(d) { return +d;} ); // get max value of our dataset
  // http://duspviz.mit.edu/d3-workshop/intro-to-d3/
  yScale = d3.scaleLinear()
    .domain([0, 1])
    .range([y_axisLength, 0]).tickFormat(5, "+%");

  // var ticks = yScale.ticks(5),
  // tickFormat = yScale.tickFormat(5, "+%");
  return [yScale, maxValue];
}
function getXscale(barXvalues){
   return xScale = d3.scaleOrdinal()
      .domain(classes)
      .range(barXvalues);
}

function drawAxes(yScale, xScale){
      var axez = chart2.append("g");
        axez
        .attr("transform", "translate("+barWidth+",-"+(y_axisLength-5)+")") // How far to shift down so ?
        .attr("id", "axes")
        .call(d3.axisLeft(yScale));

      // Add x scale
      chart2.append("g")
        .attr("transform", "translate(0,5)")
        .call(d3.axisBottom(xScale))
        .selectAll("text")
        .attr("y", 0)
        .attr("x", 9)
        .attr("dy", ".35em")
        .attr("transform", "translate(0,10)")
        .attr("id", "axes")
        .style("text-anchor", "start");
};


/////////////////////////////////////////////
/////////////////////////////////////////////
 //Adding legend for our Choropleth
/////////////////////////////////////////////
/////////////////////////////////////////////

var ext_color_domain = [.2, .4, .6, .8, 1]
var legend_labels = ["0-20%", "20-40%", "40-60%", "60-80%", "80-100%"]              


  var legend = chart1.selectAll("g.legend")
  .attr("transform", "rotate(90)")
  .data(ext_color_domain)
  .enter().append("g")
  .attr("class", "legend");

  var ls_w = 20, ls_h = 20;

  legend.append("rect")
  .attr("x", 20)
  .attr("y", function(d, i){ return height - (i*ls_h) - 2*ls_h;})
  .attr("width", ls_w)
  .attr("height", ls_h)
  .style("fill", function(d, i) { return color(d); })
  .style("opacity", 0.8);

  legend.append("text")
  .attr("x", 50)
  .attr("y", function(d, i){ return height - (i*ls_h) - ls_h - 4;})
  .text(function(d, i){ return legend_labels[i]; });



/////////////////////////////////////////////
/////////////////////////////////////////////
// Add new data viz on click. 
/////////////////////////////////////////////
/////////////////////////////////////////////
function bar_colors(numclicks){
  if (numclicks == 0) { return  "#137ed9"; } 
  else if (numclicks == 1) { return "#00b0ff"; }
  else if (numclicks == 2) { return "#0c9fc6"; }
  else if (numclicks == 3) { return "#0ab4c8"; }
  else if (numclicks == 4) { return "#00d7ff"; }
};

yScale = d3.scaleLinear()
    .domain([0, 1])
    // .domain([0, maxValue])
    .range([y_axisLength, 0]);
    barXvalues =  get_CLASS_bar_x_positions();
    xScale = getXscale(barXvalues);
    
    drawAxes(yScale, xScale);

var div = d3.select("body").append("div") 
    .attr("class", "tooltip")       
    .style("opacity", 0);


function get_current_county_id(d) {
  return d.id
};

function chartonClick(did, numclicks, initialYear, race) {

    var fileName = race+initialYear+"map.csv"

    var currentCounty = county.get(did);
    var currentState = state.get(did);

    d3.csv("mapData/"+race+"/"+fileName, function(error, data) {
      if (error) throw error;


      filtered_data = filterbyCounty(data, currentCounty, currentState);
      proportions = getDistribution(filtered_data);
      class_dist = low_Middle_High_class(proportions);

   
      d3.selectAll("#incomebars").remove(); // Remove old bar.
      d3.selectAll("#barlabel").remove();

      // Append the rectangles (bars) for the bar chart
      var barz = chart2
        .append('g')
        .attr("transform", "translate(0,-"+height/2+")")
        .selectAll( "rect" )
        .data( class_dist );

      var barChart = barz
        .enter()
        .append("rect")
        .attr("id", "incomebars")
        .attr( "x", function(d, i){
          // return function(d, i){ return (i*barSpacing)}; 
        // })
          numclicks = 1
          return bar_location(d, i, numclicks); // Set x coordinate of rectangle to index of data value (i)*25.
          })
        .attr("y", function(d) {
        return yScale(-getYscale(class_dist)[1]);
        })
        .attr("height", 0)
        .attr( "y", function(d){
          return yScale(d); // Set y coordinate for each bar to height minus the data value
          })
        .attr( "width", barWidth )
        .attr( "height", function(d){
          return height/2 - yScale(d); // Set height of rectangle to data value
          })
        .attr("fill", "red");
        // .attr("fill", bar_colors(numclicks));

      barChart
        .on("mouseover", function(d, i) {	
        	d3.select(this)
            div.transition()		
                .duration(200)		
                .style("opacity", .9);

            div	.html( Math.round((100*d),0)+ "% of "+race.charAt(0).toUpperCase()+ race.substr(1)
             + " Households in " + classes[i] +" bracket in " + currentCounty + "," + currentState+" in "+initialYear)	
                .style("left", (d3.event.pageX) + "px")		
                .style("top", (d3.event.pageY - 28) + "px");	
            })			
        .on("mouseout", function(d) {		
            div.transition()		
                .duration(500)		
                .style("opacity", 0);	
        });

});
};

</script>
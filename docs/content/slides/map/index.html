<!-- used resources: -->
<!-- 

 -->
<!-- http://www.d3noob.org/2013/01/adding-title-to-your-d3js-graph.html
hover: http://bl.ocks.org/mattparrilla/5724610
basic chloropleth https://bl.ocks.org/mbostock/4060606
youtube map https://www.youtube.com/watch?v=G-VggTK-Wlg
click zoom http://bl.ocks.org/phil-pedruco/7557092 -->
<!-- scroll zoom https://bl.ocks.org/iamkevinv/0a24e9126cd2fa6b283c6f2d774b69a2 -->
<!-- scale https://bl.ocks.org/andrew-reid/496078bd5e37fd22a9b43fd6be84b36b -->
<!-- https://bl.ocks.org/d3noob/bdf28027e0ce70bd132edc64f1dd7ea4 bar chart v4! -->
<!-- 

 -->

<!DOCTYPE html>
<meta charset="utf-8">
<style>
.container {
  float: left;
}
.counties {
  fill: none;
}
.states {
  fill: none;
  stroke: #fff;
  stroke-linejoin: round;
}
.background {
	fill: green;
  stroke: white;
  stroke-linejoin: round;
}
.title {
	fill: darkred;
}
</style>

<script src="https://d3js.org/d3.v4.min.js"></script> 
<script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script> 
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script> 
<script src="https://d3js.org/topojson.v2.min.js"></script>
<script src="https://d3js.org/d3-axis.v1.min.js"></script>

<body>
</body>

<script>

//////////////////////////////////////////
//////////////////////////////////////////
// Set the dimensions of the canvas/graph.
//////////////////////////////////////////
//////////////////////////////////////////
var margin = {top: 40, right: 20, bottom: 30, left: 50};
var width = 550;
var height = 550;

//////////////////////////////////////////
//////////////////////////////////////////
// Assign global variables. 
//////////////////////////////////////////
//////////////////////////////////////////



//////////////////////////////////////////
//////////////////////////////////////////
// Make the map.
//////////////////////////////////////////
//////////////////////////////////////////
var chart1 = d3.select("body").append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom);
chart1.append("rect")
    .attr("class", "background")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom);
var g = chart1.append("g");
var color = d3.scaleLinear().domain([0, .5]).range(['lightblue', 'darkblue']);

//////////////////////////////////////////
// Scale map down
//////////////////////////////////////////
function scale (scaleFactor,width,height) {
  return d3.geoTransform({
    point: function(x, y) {
      this.stream.point( (x - width/2) * scaleFactor+300 , (y - height/2) * scaleFactor + height/5); // + height/2);
                          }
  });
}
var mapScale = .6
var path = d3.geoPath()
  .projection(scale(mapScale,width,height))

//////////////////////////////////////////
// Interactive map function.
//////////////////////////////////////////
function ready(error, us) {
  if (error) throw error;

  g.append("g")
      .attr("class", "counties")
      .selectAll("path")
      .data(topojson.feature(us, us.objects.counties).features)
      .enter()
      .append("path")
      .attr("fill", function(d) { return color(d.percent_poor = poverty.get(d.id)); })
      .attr("transform", "translate("+-2*margin.left+","+5*margin.top+")")
      .attr("d", path)
      .on("click", function(d){
          chartonClick(d);
      })
      .on("mouseover", function(d) {
                    var xPosition = d3.mouse(this)[0];
                    var yPosition = d3.mouse(this)[1] - 30;

                    g.append("text")
                        .attr("id", "tooltip")
                        .attr("x", xPosition)
                        .attr("y", yPosition)
                      .attr("transform", "translate("+-2*margin.left+","+5*margin.top+")")
                        .attr("text-anchor", "middle")
                        .attr("font-family", "sans-serif")
                        .attr("font-size", "11px")
                        .attr("font-weight", "bold")
                        .style("fill", "darkred")
                        .text(county.get(d.id));
                        // .text(d.percent_poor * 100 + '%');

                    d3.select(this)
                    .style("fill", "darkred");
                         })
      .on("mouseout", function(d) {
                    d3.select("#tooltip").remove();

                    d3.select(this)
                    .transition()
                    .duration(600)
                    .attr("fill", color(d.percent_poor))
                    .style("fill", function(d) {
                      return color(d.percent_poor);
                    })
                });

  g.append("path")
      .datum(topojson.mesh(us, us.objects.states, function(a, b) { return a !== b; }))
      .attr("class", "states")
      .attr("transform", "translate("+-2*margin.left+","+5*margin.top+")")
      .attr("d", path);

  chart1.append("path")
      .datum(topojson.mesh(us, us.objects.counties, function(a, b) { return a !== b; }))
      .attr("class", "counties")
      .attr("transform", "translate("+-2*margin.left+","+5*margin.top+")")
      .attr("d", path);
} // Close ready() function


//////////////////////////////////////////
//////////////////////////////////////////
// Set the title.
//////////////////////////////////////////
//////////////////////////////////////////
var textWidth = width / 2
chart1.append("text")
        .attr("x", textWidth) // Center            
        .attr("y", margin.top*.5) 
        .attr("text-anchor", "middle")  
        .style("font-size", "26px") 
        .style("text-decoration", "underline")
        .attr("class", "title")  
        .text("Poverty in America")

chart1.append("text")
        .attr("x", textWidth)           
        .attr("y", margin.top * 1.5) 
        .attr("text-anchor", "middle")  
        .style("text-decoration", "underline")  
        .attr("class", "title")  
        .style("font-size", "16px") 
        .text("Percent of households in county making less than $20,000. Click once/twice to zoom in/out.")

//////////////////////////////////////////
//////////////////////////////////////////
// Zoom functionality.
//////////////////////////////////////////
//////////////////////////////////////////
var zoom = d3.zoom()
    .scaleExtent([1, 8])
    .on("zoom", zoomed);
chart1
    .call(zoom);
function zoomed() {
  g.style("stroke-width", 1.5 / d3.event.transform.k + "px");
  g.attr("transform", d3.event.transform); // updated for d3 v4
};

//////////////////////////////////////////
//////////////////////////////////////////
// Make map (load data).
//////////////////////////////////////////
//////////////////////////////////////////
var poverty = d3.map();
var state = d3.map();
var county = d3.map();

d3.queue()
    .defer(d3.json, "https://d3js.org/us-10m.v1.json") // USA County Map
    .defer(d3.csv, "income.csv", function(d) { 
      poverty.set(d.id, +d.percent_poor); // Need for choropleth.
      state.set(d.id, d.State); // Need for filtering data.
      county.set(d.id, d.County);}) // ""
    .await(ready);


/////////////////////////////////////////////
// Prepare for second chart.
/////////////////////////////////////////////
 var chart2 = d3.select("body").append("svg") // append to svg will put side by side if there is enough room.
    .attr("width", width) 
    .attr("height", height)
  	.append("g")
  	.attr("transform","translate(40,"+height/2+")"); // Move chart to center of SVG

var distribution_breakdowns = [
                                "Estimate; Total: - Less than $10,000"
                                ,"Estimate; Total: - $10,000 to $14,999"
                                ,"Estimate; Total: - $15,000 to $19,999"
                                ,"Estimate; Total: - $20,000 to $24,999"
                                ,"Estimate; Total: - $25,000 to $29,999"
                                ,"Estimate; Total: - $30,000 to $34,999"
                                ,"Estimate; Total: - $35,000 to $39,999"
                                ,"Estimate; Total: - $40,000 to $44,999"
                                ,"Estimate; Total: - $45,000 to $49,999"
                                ,"Estimate; Total: - $50,000 to $59,999"
                                ,"Estimate; Total: - $60,000 to $74,999"
                                ,"Estimate; Total: - $75,000 to $99,999"
                                ,"Estimate; Total: - $100,000 to $124,999"
                                ,"Estimate; Total: - $125,000 to $149,999"
                                ,"Estimate; Total: - $150,000 to $199,999"
                                ,"Estimate; Total: - $200,000 or more"
                              ]

/////////////////////////////////////////////
// Helper functions for onclick update.
/////////////////////////////////////////////
function filterbyCounty(x, currentCounty, currentState){
  return x.filter(function(d) { return d.County === currentCounty & d.State === currentState; });
};

function getDistribution(data){
  var proportions = []
  var countyPopulation = data[0]["Estimate; Total:"]
  // Populate the income distribution list `proportions`
  for(var i=0; i<distribution_breakdowns.length; i++){
    proportions.push( data[0][distribution_breakdowns[i]]  / countyPopulation);
  }
  return proportions
};

function spread(i){
  // Spread a sequence (say, of x values), out.
  return i*20+20;
};
function get_bar_x_positions(){
  var barXvalues = [];
  for(var i=0; i<distribution_breakdowns.length; i++){
    barXvalues.push(spread(i));
  }
  return barXvalues;
};


var y_axisLength = (height / 2)*.85;
function getYscale(proportions){
  var maxValue = d3.max(proportions, function(d) { return +d;} ); // get max value of our dataset
  console.log(maxValue);
  // http://duspviz.mit.edu/d3-workshop/intro-to-d3/
  yScale = d3.scaleLinear()
    .domain([0, maxValue])
    .range([y_axisLength, 0]);
  return [yScale, maxValue];
}
function getXscale(barXvalues){
   return xScale = d3.scaleOrdinal()
      .domain(distribution_breakdowns)
      .range(barXvalues); //result
}

function drawAxes(yScale, xScale){
      var axez = chart2.append("g");
        axez
        .attr("transform", "translate(0,-"+y_axisLength+")") // How far to shift down so ?
        .attr("id", "axes")
        .call(d3.axisLeft(yScale));

      // Add x scale
      chart2.append("g")
        .attr("transform", "translate(0,0)")
        .call(d3.axisBottom(xScale))
        .selectAll("text")
        .attr("y", 0)
        .attr("x", 9)
        .attr("dy", ".35em")
        .attr("transform", "rotate(90)")
        .attr("id", "axes")
        .style("text-anchor", "start");
};
/////////////////////////////////////////////
/////////////////////////////////////////////
// Draw initial chart.
/////////////////////////////////////////////
/////////////////////////////////////////////
// var barz;
function initialChart() {
    var currentState = 'North Carolina'
    var currentCounty = 'Harnett County'

    d3.csv("income.csv", function(error, data) {
      if (error) throw error;
  
      data = filterbyCounty(data, currentCounty, currentState);
      proportions = getDistribution(data);

      barXvalues  = get_bar_x_positions();
      yScale = getYscale(proportions)[0];
      xScale = getXscale(barXvalues);
      drawAxes(yScale, xScale);


      // Append the rectangles (bars) for the bar chart
      barz = chart2
        .append('g')
        .attr("transform", "translate(0,-"+height/2+")")
        .selectAll( "rect" )
        .data( proportions );

      barz
        .enter()
        .append("rect")
        .attr( "x", function(d,i){
          return spread(i); // Set x coordinate of rectangle to index of data value (i)*25.
          })
        .attr( "y", function(d){
          return yScale(d); // Set y coordinate for each bar to height minus the data value
          })
        .attr( "width", 10 )
        .attr( "height", function(d){
          return height/2 - yScale(d); // Set height of rectangle to data value
          })
        .attr( "fill", "green")
        .attr("id",function(d,i){
          return "bar"+i; // Set x coordinate of rectangle to index of data value (i)*25.
          });
});
};
initialChart(); // Call to initially populate with inital chart.

/////////////////////////////////////////////
/////////////////////////////////////////////
// Add new data viz on click. 
/////////////////////////////////////////////
/////////////////////////////////////////////
function chartonClick(d) {
    var currentCounty = county.get(d.id);
    var currentState = state.get(d.id);

    d3.csv("income.csv", function(error, data) {
      if (error) throw error;
  
      data = filterbyCounty(data, currentCounty, currentState);
      proportions = getDistribution(data);

      d3.selectAll("rect").remove(); // Remove old bar.
      d3.selectAll("#axes").remove(); // Remove old axes.
      

      barXvalues  = get_bar_x_positions();
      yScale = getYscale(proportions)[0];
      xScale = getXscale(barXvalues);
      drawAxes(yScale, xScale);


      // Append the rectangles (bars) for the bar chart
      var barz = chart2
        .append('g')
        .attr("transform", "translate(0,-"+height/2+")")
        .selectAll( "rect" )
        .data( proportions );

      barz
        .enter()
        .append("rect")
        .attr( "x", function(d,i){
          return spread(i); // Set x coordinate of rectangle to index of data value (i)*25.
          })
        .attr("y", function(d) {
        return yScale(-getYscale(proportions)[1]);
        })
        .attr("height", 0)
        .transition()
        .duration(100)
        .attr( "y", function(d){
          return yScale(d); // Set y coordinate for each bar to height minus the data value
          })
        .attr( "width", 10 )
         // .transition()
        // .duration(2000)
        .attr( "height", function(d){
          return height/2 - yScale(d); // Set height of rectangle to data value
          })
        .attr( "fill", "red");
});
};

</script>
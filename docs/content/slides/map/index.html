<!-- used resources: -->
<!-- 

 -->
<!-- http://www.d3noob.org/2013/01/adding-title-to-your-d3js-graph.html
hover: http://bl.ocks.org/mattparrilla/5724610
basic chloropleth https://bl.ocks.org/mbostock/4060606
youtube map https://www.youtube.com/watch?v=G-VggTK-Wlg
click zoom http://bl.ocks.org/phil-pedruco/7557092 -->
<!-- scroll zoom https://bl.ocks.org/iamkevinv/0a24e9126cd2fa6b283c6f2d774b69a2 -->
<!-- scale https://bl.ocks.org/andrew-reid/496078bd5e37fd22a9b43fd6be84b36b -->
<!-- https://bl.ocks.org/d3noob/bdf28027e0ce70bd132edc64f1dd7ea4 bar chart v4! -->
<!-- 

 -->

<!DOCTYPE html>
<meta charset="utf-8">
<style>
.container {
  float: left;
}
.counties {
  fill: none;
}
.states {
  fill: none;
  stroke: #fff;
  stroke-linejoin: round;
}
.background {
	fill: green;
	/*fill: white;*/
  stroke: white;
  stroke-linejoin: round;
}
.title {
	fill: darkred;
  /*stroke: darkred;*/
}
</style>

<script src="https://d3js.org/d3.v4.min.js"></script> 
<script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script> 
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script> 
<script src="https://d3js.org/topojson.v2.min.js"></script>
<script src="https://d3js.org/d3-axis.v1.min.js"></script>

<body>
	<div class="container" id="chart1">
</div>
<!-- <div class="container" id="chart2"> -->
<!-- </div> -->
</body>

<script>

//////////////////////////////////////////
//////////////////////////////////////////
// Set the dimensions of the canvas / graph.
//////////////////////////////////////////
//////////////////////////////////////////
var rawHeight = 650;
var margin = {top: 40, right: 20, bottom: 30, left: 50};
var width = w = 1332/2 - margin.left - margin.right;
var height = h = (rawHeight); // - margin.top - margin.bottom);

//////////////////////////////////////////
//////////////////////////////////////////
// Assign global variables. 
//////////////////////////////////////////
//////////////////////////////////////////
var rawHeight = 700
var centered;
var currentState;



//////////////////////////////////////////
//////////////////////////////////////////
// Make the map.
//////////////////////////////////////////
//////////////////////////////////////////
var chart1 = d3.select("body").append("svg")
// var chart1 = d3.select("#chart1").append("svg")
    .attr("width", width)
    .attr("height", height);
    // .attr("transform", "translate(,0)");

chart1.append("rect")
    .attr("class", "background")
    .attr("width", width)
    .attr("height", height)
    .on("click", reset);

var g = chart1.append("g");

function scale (scaleFactor,width,height) {
  return d3.geoTransform({
    point: function(x, y) {
      this.stream.point( (x - width/2) * scaleFactor+300 , (y - height/2) * scaleFactor + height/5); // + height/2);
    }
  });
}
var mapScale = .6
var path = d3.geoPath()
  .projection(scale(mapScale,width,height))

var x = d3.scaleLinear()
    .domain([1, 10])
    .rangeRound([600, 860]);

var color = d3.scaleLinear().domain([0, .5]).range(['lightblue', 'darkblue']);

/////
//////
// Interactive map.
/////
//////


function ready(error, us) {
  if (error) throw error;

  g.append("g")
      .attr("class", "counties")
    .selectAll("path")
    .data(topojson.feature(us, us.objects.counties).features)
    .enter().append("path")
      .attr("fill", function(d) { return color(d.percent_poor = poverty.get(d.id)); })
      .attr("transform", "translate("+-2*margin.left+","+5*margin.top+")")
      .attr("d", path)
      .on("click", function(d){
          // clicked(d);
          chartonClick(d);
          // updateData(d);
      })

      .on("mouseover", function(d) {
                    var xPosition = d3.mouse(this)[0];
                    var yPosition = d3.mouse(this)[1] - 30;

                    g.append("text")
                        .attr("id", "tooltip")
                        .attr("x", xPosition)
                        .attr("y", yPosition)
                      .attr("transform", "translate("+-2*margin.left+","+5*margin.top+")")
                        .attr("text-anchor", "middle")
                        .attr("font-family", "sans-serif")
                        .attr("font-size", "11px")
                        .attr("font-weight", "bold")
                        .style("fill", "darkred")
                        .text(d.percent_poor * 100 + '%');

                    d3.select(this)
                    .style("fill", "darkred");
                         })

      .on("mouseout", function(d) {
                    d3.select("#tooltip").remove();

                    d3.select(this)
                    .transition()
                    .duration(250)
                    .attr("fill", color(d.percent_poor))
                    .style("fill", function(d) {
                      return color(d.percent_poor);
                    })
                });

  g.append("path")
      .datum(topojson.mesh(us, us.objects.states, function(a, b) { return a !== b; }))
      .attr("class", "states")
      .attr("transform", "translate("+-2*margin.left+","+5*margin.top+")")
      .attr("d", path);

  chart1.append("path")
      .datum(topojson.mesh(us, us.objects.counties, function(a, b) { return a !== b; }))
      .attr("class", "counties")
      .attr("transform", "translate("+-2*margin.left+","+5*margin.top+")")
      .attr("d", path);

}


//////////////////////////////////////////
//////////////////////////////////////////
// Set the title.
//////////////////////////////////////////
//////////////////////////////////////////
var title = d3.select("chart1").append("svg")
// var title = d3.select("#chart1").append("svg")
    .attr("width", width)
    .attr("height", 2*margin.top);

var textWidth = width / 2
title.append("text")
        .attr("x", textWidth) // Center            
        .attr("y", margin.top*.5) 
        .attr("text-anchor", "middle")  
        .style("font-size", "26px") 
        .style("text-decoration", "underline")
        .attr("class", "title")  
        .text("Poverty in America")

title.append("text")
        .attr("x", textWidth) // Center            
        .attr("y", margin.top * 1.5) 
        .attr("text-anchor", "middle")  
        .style("text-decoration", "underline")  
        .attr("class", "title")  
        .style("font-size", "16px") 
        .text("Percent of households in county making less than $20,000. Click once/twice to zoom in/out.")

//////////////////////////////////////////
//////////////////////////////////////////
// Zoom functionality.
//////////////////////////////////////////
//////////////////////////////////////////
var zoom = d3.zoom()
    .scaleExtent([1, 8])
    .on("zoom", zoomed);

chart1
    .call(zoom)
// Make map
d3.queue()
    .defer(d3.json, "https://d3js.org/us-10m.v1.json") // USA County Map
    .defer(d3.csv, "income.csv", function(d) { 
      poverty.set(d.id, +d.percent_poor); 
      state.set(d.id, d.State);
      county.set(d.id, d.County);})
    .await(ready);

  
function zoomed() {
  g.style("stroke-width", 1.5 / d3.event.transform.k + "px");
  g.attr("transform", d3.event.transform); // updated for d3 v4
}

/////////////////////////////////////////////
/////////////////////////////////////////////
// Zoom on click function
/////////////////////////////////////////////
/////////////////////////////////////////////
// function clicked(d) {
//   var x, y, k;

//   if (d && centered !== d) {
//     var centroid = path.centroid(d);
//     x = centroid[0];
//     y = centroid[1];
//     k = 4;
//     centered = d;
//   } else {
//     x = width / 2;
//     y = height / 2;
//     k = 1;
//     centered = null;
//   }

//   g.selectAll("path")
//       .classed("active", centered && function(d) { return d === centered; });

//   g.transition()
//       .duration(750)
//       .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")scale(" + k + ")translate(" + -x + "," + -y + ")")
//       .style("stroke-width", 1.5 / k + "px");
// }

function reset() {
    g.selectAll(".active").classed("active", active = false);
    g.transition().duration(750).attr("transform", "");
}




/////////////////////////////////////////////
/////////////////////////////////////////////
// Add new data viz on click.
/////////////////////////////////////////////
/////////////////////////////////////////////

var poverty = d3.map();
var state = d3.map();
var county = d3.map();


 var chart2 = d3.select("body").append("svg")
  // var chart2 = d3.select("#chart1").append("svg")
    .attr("width", width)
    .attr("height", height);


var g2 = chart2.append("g")
	.attr("transform", "translate(50,-200)");


var distribution_breakdowns = ["Estimate; Total: - Less than $10,000"
,"Estimate; Total: - $10,000 to $14,999"
,"Estimate; Total: - $15,000 to $19,999"
,"Estimate; Total: - $20,000 to $24,999"
,"Estimate; Total: - $25,000 to $29,999"
,"Estimate; Total: - $30,000 to $34,999"
,"Estimate; Total: - $35,000 to $39,999"
,"Estimate; Total: - $40,000 to $44,999"
,"Estimate; Total: - $45,000 to $49,999"
,"Estimate; Total: - $50,000 to $59,999"
,"Estimate; Total: - $60,000 to $74,999"
,"Estimate; Total: - $75,000 to $99,999"
,"Estimate; Total: - $100,000 to $124,999"
,"Estimate; Total: - $125,000 to $149,999"
,"Estimate; Total: - $150,000 to $199,999"
,"Estimate; Total: - $200,000 or more"
          ]

function chartonClick(d) {

    var currentState = state.get(d.id);
    var currentCounty = county.get(d.id);

    console.log(currentState)
    console.log(currentCounty)

  d3.csv("income.csv", function(error, data) {
  if (error) throw error;
  

  data = data.filter(function(d) { return d.County === currentCounty & d.State === currentState; })
  console.log(data);
  var proportions = []
  
  var countyPopulation = data[0]["Estimate; Total:"]
  for(var i=0; i<distribution_breakdowns.length; i++){
    proportions.push( data[0][distribution_breakdowns[i]]  / countyPopulation);
  }

console.log('proportionsUpdate?');
console.log(proportions);
console.log('-------------------------------');

  var arrayLength = proportions.length; // length of dataset
  var maxValue = d3.max(proportions, function(d) { return +d;} ); // get max value of our dataset
  var x_axisLength = width - margin.left; // length of x-axis in our layout
  var y_axisLength = height / 2;

  // http://duspviz.mit.edu/d3-workshop/intro-to-d3/
  var yScale = d3.scaleLinear()
  // .domain([0, 1])
  .domain([0, maxValue])
  .range([y_axisLength, 0]);


  var result = [];
  for(var i=0; i<distribution_breakdowns.length; i++){
    result.push(i*25 + 30);
  }

  var xScale = d3.scaleOrdinal()
  .domain(distribution_breakdowns)
  .range(result); //result

  console.log(height - yScale(maxValue));

  g2.append("g")
      .attr("transform", "translate(0,"+y_axisLength+")") // How far to shift down so ?
      .call(d3.axisLeft(yScale));

   g2.append("g")
      .attr("transform", "translate(0,"+height+")")
      .call(d3.axisBottom(xScale))
      .selectAll("text")
    .attr("y", 0)
    .attr("x", 9)
    .attr("dy", ".35em")
    .attr("transform", "rotate(90)")
    .style("text-anchor", "start");


  // append the rectangles for the bar chart
  var barz = g2.selectAll( "rect" )
    .data( proportions );

  barz.exit().remove();

  barz
    .enter()
    .append("rect")
    .attr( "x", function(d,i){
      console.log('--------------*******************__________________');
      console.log(d);
      return i*25 + 30; // Set x coordinate of rectangle to index of data value (i)*25.

      // Add 30 to account for our left margin.
    })
    .attr( "y", function(d){
      return height - yScale(d); // Set y coordinate for each bar to height minus the data value
    })
    .attr( "width", 10 )
    .attr( "height", function(d){
      return yScale(d) ; // Set height of rectangle to data value
    })
    .attr( "fill", "red")
    .text(function(d){ return d;});
});
}

</script>